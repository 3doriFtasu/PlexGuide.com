#!/bin/bash
#
# Title:      PlexGuide (Reference Title File)
# YML Author: Admin9705
# URL:        https://plexguide.com - http://github.plexguide.com
# GNU:        General Public License v3.0
# Origin:     https://github.com/l3uddz/plex_patrol
################################################################################
---
- hosts: localhost
  gather_facts: false
  tasks:

# FACTS ######################################################################
  - name: "Set Known Facts"
    set_fact:
      pgrole: "pgpatrol"
      extport: "0"

  - name: Server ID
    shell: "cat /var/plexguide/pg.serverid"
    register: serverid

  - name: Token Recall
    shell: "cat /var/plexguide/plex.token"
    register: plextoken

  - name: CronJob Role
    include_tasks: "/opt/plexguide/containers/_core.yml"

  - name: Create Basic Directories
    file: "path={{item}} state=directory mode=0775 owner=1000 group=1000"
    with_items:
        - "/opt/appdata/pgpatrol/"

  - name: Check INI's Existance
    stat:
      path: "/opt/appdata/pgpatrol/settings.ini"
    register: config

  - name: Transfer Files
    copy:
      src: /opt/plexguide/menu/pgpatrol
      dest: /opt/appdata
      owner: "1000"
      group: "1000"
      mode: a+x
      force: yes

  - name: Import default config
    template:
      src: /opt/appdata/pgpatrol/settings.ini.default
      dest: /opt/appdata/pgpatrol/settings.ini
      owner: "1000"
      group: "1000"
      mode: 0775
      force: yes
    when: not config.stat.exists

  - name: Remove Services
    include_tasks: "/opt/appdata/pgpatrol/menu/service-remove.yml"

  - name: Install Service
    template:
      src: unionfs.js2
      dest: /opt/appdata/pgpatrol/system/pgpatrol.service
      force: yes

  - name: Daemon-Reload
    systemd: state=stopped name=pgpatrol daemon_reload=yes enabled=no

  - name: Start UnionFS
    systemd: state=started name=pgpatrol enabled=yes
