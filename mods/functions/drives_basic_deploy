#!/bin/bash
############# https://github.com/plexguide/PlexGuide.com/graphs/contributors ###
drives_basic_deploy() {

# create file folder for sizes
  rm -rf /pg/var/drives/sizes && common_fcreate_silent /pg/var/drives/sizes/

# clears upload list
  rm -rf /pg/var/transport/*

# pulls key variables
drives_menu_start_setup

# declare variables and remove
path_upload="/pg/var/upload"
path_exempt_programs="/pg/var/upload"; mkdir -p "$path_exempt_programs"
mkdir -p $path_upload && rm -rf "$path_upload"/{upload.short,upload.long}

#exempt file locations
find /pg/complete/ -type f -mmin +1 -printf "\n%AT %p" | sort -k1 | cut -d " " -f 2- | tail -n +2 > "$path_upload"/upload.long

#drives_deploy_exempt
while read l; do
sed -i -e "/$l/d" "$path_upload"/upload.long
done <"$path_exempt_programs"/exempt.list

# generates short files
  while read p; do
      remove_path="/pg/complete"
          echo "${p#*$remove_path}" >> "$path_upload"/upload.short
  done <"$path_upload"/upload.long

echo "$(ls /pg/var/transport)" > /pg/var/upload/slot.list
# transport process
merit_count=0
while read b; do
  echo "TEST2 - ${b}"
  echo "SHORT - $shortkey and LONG - $longkey"
  dircheck=$(ls "/pg/var/transport/${b}")
  if [[ "$dircheck" == "" ]]; then


    # moves along the merit list
    let "merit_count=merit_count+1"
    echo "merit: $merit_count"
    rclone_long=$(sed "${merit_count}q;d" /pg/var/upload/upload.long)

    if [[ "$rclone_long" != "" ]]; then
      rclone_short=$(sed "${merit_count}q;d" /pg/var/upload/upload.short)

        # execute if not empty
        echo $b
        common_fcreate_silent "/pg/var/transport/${b}"
        mkdir -p "/pg/var/transport/${b}"
        touch "/pg/var/transport/${b}/rclone.log"
        echo "$rclone_short" > "/pg/var/transport/${b}/key.short"
        echo "$rclone_long" > "/pg/var/transport/${b}/key.long"
        shortkey=$(cat /pg/var/transport/${b}/key.short)
        longkey=$(cat /pg/var/transport/${b}/key.long)
        if [[ "$longkey" != "" ]]; then

          #removes junk vars
          rm -rf "/pg/var/drives/sizes/$shortkey.1" cat "/pg/var/drives/sizes/$shortkey.2"

          echo "TRANSFERING GSUITE - $longkey"
          rclone moveto "$longkey" gd:"$shortkey" \
            --config=/pg/var/drives/gd/gd.conf \
            --log-file="/pg/var/transport/${b}/rclone.log" \
            --log-level=INFO --stats=5s --stats-file-name-length=0
    fi; fi; fi
done </pg/var/upload/slot.list

# if completed, then free slot for upload
while read m; do
  if [[ -e "/pg/var/transport/${m}/key.short" ]]; then
    echo "/pg/var/transport/${m}/key.short"
    shortkey=$(cat "/pg/var/transport/${m}/key.short")
    shortkey=$(echo ${shortkey} | cut -c 2-)
    delete_check=$(rclone ls --config /pg/var/drives/gd/gd.conf --max-depth 1 gd: | grep "${shortkey}")
    if [[ "$delete_check" != "" ]]; then rm -rf /pg/var/transport/${m}/* && echo "FREED - {$m}"; fi
  fi
done </pg/var/upload/slot.list

# repeat
drives_basic_deploy
}
