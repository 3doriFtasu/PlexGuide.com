#!/bin/bash
############# https://github.com/plexguide/PlexGuide.com/graphs/contributors ###
drives_basic_deploy() {

# pulls key variables
drives_menu_start_setup

# temporary for file test generation
rm -rf /pg/transfer/*
mkdir -p /pg/transfer/{01,02,03,04,05,06,07,08}
tempfile=$(date +"%T")
echo "" >> "/pg/complete/nzbget/${tempfile}-nzbget01"
echo "" >> "/pg/complete/nzbget/${tempfile}-nzbget03"
echo "" >> "/pg/complete/nzbget/${tempfile}-nzbget02"

echo "" >> "/pg/complete/rutorrent/${tempfile}-rutorrent11"
echo "" >> "/pg/complete/rutorrent/${tempfile}-rutorrent4"
echo "" >> "/pg/complete/rutorrent/${tempfile}-rutorrent9"

# declare variables and remove
path_upload="/pg/var/upload"
mkdir -p $path_upload && rm -rf "$path_upload"/{upload.short,upload.long}
merit_count=0
mkdir /

while read z; do
echo "$(find /pg/complete/$z -type f -printf "\n%AT %p" | awk '{print $2}' | tail -n +2)" >> "$path_upload"/upload.long

# generates short and long paths for upload
  while read p; do
      remove_path="/pg/complete/$z"
      valid=$(echo $p | grep $z)
        if [[ "$valid" != "" ]]; then
          echo "${p#*$remove_path}" >> "$path_upload"/upload.short; fi
    done <"$path_upload"/upload.long
done <"$path_upload"/program.list

echo "TESTING"
echo "$(ls /pg/transport)" > /pg/var/upload/slot.list

while read b; do
  #echo "TEST2 - $b"
  if [[ "" == "$(ls /pg/transport/$b)" ]]; then

    #echo "TEST3 - $merit_count"
    # moves along the merit list
    let "merit_count=merit_count+1"
    rclone_long=$(sed "${merit_count}q;d" /pg/var/upload/upload.long)
    rclone_short=$(sed "${merit_count}q;d" /pg/var/upload/upload.short)

    echo "$rclone_long - $rclone_short"
      # execute if not empty
      common_fcreate_silent "/pg/transfer/${b}"
      touch "/pg/transfer/${b}${rclone_short}.log"
      #echo "TEST4 - $rclone_long"
      if [[ "$rclone_long" != "" ]]; then
        rclone moveto "$rclone_long" gd:"$rclone_short" \
          --config=/pg/var/drives/gd/gd.conf \
          --log-file="/pg/transfer/${b}${rclone_short}.log" \
          --log-level=INFO --stats=5s --stats-file-name-length=0
      fi
  fi

done </pg/var/upload/slot.list

}
