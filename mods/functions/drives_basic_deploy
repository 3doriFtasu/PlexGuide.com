#!/bin/bash
############# https://github.com/plexguide/PlexGuide.com/graphs/contributors ###
drives_basic_deploy() {

# pulls key variables
  drives_menu_start_setup
# move this later and better script prior to transport deployment / this is just temporary to get it going
# this needs to use the options from the drives menu; removes and builds number based on options
  transport_path="/pg/var/transport"
  mkdir -p "$transport_path"/{01,02,03,04,05,06,07,08}

# create file folder for sizes
  rm -rf /pg/var/drives/sizes && common_fcreate_silent /pg/var/drives/sizes/
  echo "$(ls /pg/var/transport)" > /pg/var/upload/slot.list

# declare variables and remove
path_upload="/pg/var/upload"; path_exempt_programs="/pg/var/upload"; mkdir -p "$path_exempt_programs"
mkdir -p $path_upload && rm -rf "$path_upload"/{upload.short,upload.long}

#exempt file locations
# find /pg/complete/ -type f -mmin +1 -printf "\n%AT %p" | sort -k1 | cut -d " " -f 2- | tail -n +2 > "$path_upload"/upload.long
find /pg/complete/ -type f -printf "\n%AT %p" | sort -k1 | cut -d " " -f 2- | tail -n +2 > "$path_upload"/upload.long

# generates short files
  while read p; do
      remove_path="/pg/complete"
          echo "${p#*$remove_path}" >> "$path_upload"/upload.short
  done <"$path_upload"/upload.long

#drives_deploy_exempt
while read l; do
sed -i -e "/$l/d" "$path_upload"/upload.long
done <"$path_exempt_programs"/exempt.list

echo "FLAG 0"
# exempt files already uploading
rm -rf "$path_upload"/left.upload && touch "$path_upload"/left.upload
rm -rf "$path_upload"/left.upload && touch "$path_upload"/left.upload

# moves along the merit list
#echo "merit: $merit_count"

rclone_long=$(sed "${merit_count}q;d" /pg/var/upload/upload.long)
if [[ "$rclone_long" != "" ]]; then
  rclone_short=$(sed "${merit_count}q;d" /pg/var/upload/upload.short); fi

  # loops if nothing is to upload
  info_check=$(cat "$path_upload"/upload.long)
  if [[ "$info_check" == "" ]]; then
  sleep 1
  echo "FLAG Z"
  drives_basic_deploy && exit; fi

while read b; do
  if [[ ! -e "/pg/var/transport/${tmp288}/key.long" ]]; then
    let "merit_count=merit_count+1"
    sed "${merit_count}q;d" "$path_upload"/upload.long >> /pg/var/transport/${b}/key.long
    sed "${merit_count}q;d" "$path_upload"/upload.short >> /pg/var/transport/${b}/key.short
    echo "$tmp288" >> "$path_upload"/left.upload; fi
    echo "FLAG .5 - $tmp288"

    common_fcreate_silent "/pg/var/transport/${b}"
    mkdir -p "/pg/var/transport/${b}"

    shortkey=$(cat /pg/var/transport/${b}/key.short)
    longkey=$(cat /pg/var/transport/${b}/key.long)
    drives_basic_deploy_transporter_execute
    sleep .5
done <"$path_upload"/slot.list

echo "FLAG 1"
# starts the upload process
drives_basic_deploy_transporter

# if completed, then free slot for upload
while read m; do
  drives_basic_deploy_slot_check
done </pg/var/upload/slot.list

# repeat
drives_basic_deploy && exit
}
